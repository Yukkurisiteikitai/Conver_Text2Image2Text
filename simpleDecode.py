import json
from PIL import Image

def hex_to_rgb(hex_color):
    """ #RRGGBB 形式の16進数カラーコードを (R, G, B) タプルに変換する """
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6:
        raise ValueError(f"無効な16進数カラーコードです: {hex_color}")
    return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))

def create_image_from_json_string(json_data_string):
    """
    JSON文字列からピクセルデータを読み込み、Pillow Imageオブジェクトを生成する。
    """
    try:
        data = json.loads(json_data_string)
    except json.JSONDecodeError as e:
        print(f"JSONデータの解析に失敗しました: {e}")
        return None

    width = data.get("width")
    height = data.get("height")
    pixels_hex = data.get("pixels")

    if not all([isinstance(width, int), isinstance(height, int), isinstance(pixels_hex, list)]):
        print("JSONデータの形式が正しくありません。'width', 'height', 'pixels'が必要です。")
        return None

    if height != len(pixels_hex) or (height > 0 and width != len(pixels_hex[0])):
        print("画像の高さまたは幅がピクセルデータと一致しません。")
        return None

    # 新しい画像を作成 (RGBモード)
    image = Image.new("RGB", (width, height))

    # ピクセルデータを画像に書き込む
    for y in range(height):
        if len(pixels_hex[y]) != width:
            print(f"{y+1}行目のピクセル数が幅({width})と一致しません。")
            return None
        for x in range(width):
            try:
                hex_color = pixels_hex[y][x]
                rgb_color = hex_to_rgb(hex_color)
                image.putpixel((x, y), rgb_color)
            except ValueError as e:
                print(f"ピクセル ({x},{y}) の色変換に失敗しました: {e}")
                return None
            except IndexError:
                print(f"ピクセルデータ ({x},{y}) へのアクセスでエラーが発生しました。")
                return None
    
    return image

# あなたが提供したチョコレートのJSONデータ
json_string_chocolate = """
{
  "width": 32,
  "height": 32,
  "pixels": [
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#CC0000","#8B0000","#000000","#000000","#000000","#8B0000","#CC0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF3333","#FF3333","#CC0000","#8B0000","#000000","#8B0000","#CC0000","#FF3333","#FF3333","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF6666","#FF3333","#FF3333","#FF3333","#CC0000","#8B0000","#CC0000","#FF3333","#FF3333","#FF6666","#FF6666","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF6666","#FF3333","#FF3333","#FF3333","#FF3333","#FF3333","#FF3333","#FF6666","#FF9999","#FF9999","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF9999","#FF6666","#FF3333","#CC0000","#FF3333","#FF3333","#CC0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF6666","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF6666","#FF3333","#CC0000","#8B0000","#CC0000","#CC0000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF6666","#FF3333","#CC0000","#8B0000","#600000","#600000","#8B0000","#8B0000","#600000","#600000","#8B0000","#CC0000","#FF3333","#FF6666","#FF9999","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF6666","#FF3333","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#FF3333","#FF6666","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#8B0000","#CC0000","#FF3333","#FF3333","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#FF3333","#FF3333","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#600000","#600000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#8B0000","#8B0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#CC0000","#CC0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#8B0000","#8B0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"]
  ]
}
"""

# with open('simpleData.json',"r",encoding='utf-8') as f:
#     json_string_chocolate = json.load(f)


if __name__ == "__main__":
    # 画像を生成
    chocolate_image = create_image_from_json_string(str(json_string_chocolate))

    if chocolate_image:
        # 画像を表示
        chocolate_image.show()

        # (オプション) 画像をファイルに保存する場合
        # output_filename = "chocolate_pixel_art.png"
        # chocolate_image.save(output_filename)
        # print(f"画像を {output_filename} として保存しました。")

    # 例としてりんごのデータも試す場合
    # json_string_apple = """
    # {
    #   "width": 16,
    #   "height": 16,
    #   "pixels": [
    #     ["#000000","#000000","#000000","#000000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#FF0000","#FF3333","#FF3333","#FF3333","#FF3333","#FF3333","#FF3333","#FF0000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#FF0000","#FF3333","#FF6666","#FF6666","#FF6666","#FF6666","#FF6666","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF9999","#FF9999","#FF9999","#FF9999","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#FF6666","#FF9999","#CC0000","#CC0000","#CC0000","#FF9999","#FF9999","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#FF6666","#CC0000","#663300","#663300","#663300","#CC0000","#FF9999","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#CC0000","#663300","#663300","#663300","#663300","#663300","#CC0000","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#CC0000","#663300","#663300","#663300","#663300","#663300","#CC0000","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#FF0000","#FF3333","#FF6666","#CC0000","#663300","#663300","#663300","#CC0000","#FF9999","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#FF0000","#FF3333","#FF6666","#FF9999","#FF9999","#FF9999","#FF6666","#FF3333","#FF0000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#FF0000","#FF3333","#FF3333","#FF3333","#FF3333","#FF3333","#FF0000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#000000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#000000","#000000","#FF0000","#FF0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#000000","#000000","#000000","#FF0000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],
    #     ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"]
    #   ]
    # }
    # """
    # apple_image = create_image_from_json_string(json_string_apple)
    # if apple_image:
    #     apple_image.show()